
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        Build Android in the Cloud - 
      
      NSBogan
    </title>
    <meta name="description" content="">
    <meta name="author" content="Maksym Grebenets">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">NSBogan</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/mgrebenets" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                <li>
                  <a href="https://twitter.com/mgrebenets" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
                <li>
                  <a href="http://feeds.feedburner.com/mgrebenets@gmail.com" class="zocial rss icon" target="_blank">
                    <span class="hidden-desktop">FeedBurner</span>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          
<div class="page-header">
  <h1>
    Build Android in the Cloud 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    
<p>In this example, you are given a task to build Android app on a 64-bit AWS Linux build agent running in Amazon Cloud (AWS).</p>

<!--more-->

<h1 id="install-android-sdk">Install Android SDK</h1>

<p>You have to start with installing Android SDK first.</p>

<h2 id="download">Download</h2>
<p>Start with downloading latest Linux version, found on <a href="https://developer.android.com/sdk/index.html">this page</a>. You can find direct link to tarball in “DOWNLOAD FOR OTHER PLATFORMS” section.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">wget http://dl.google.com/android/android-sdk_r22.6.2-linux.tgz</code></pre></div>

<h2 id="extract-and-move">Extract and Move</h2>
<p>Extract it and put in preferred location, in this example it’s <code>/usr/local/opt/android-sdk</code></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># extract</span>
tar xzf android-sdk_r22.6.2-linux.tgz
<span class="c"># move</span>
mv android-sdk-linux /usr/local/opt/android-sdk</code></pre></div>

<h2 id="configure-path">Configure PATH</h2>
<p>Now configure <code>ANDROID_HOME</code> and update the path. That is done by modifying <code>~/.bash_profile</code>, create the file if you don’t have it yet.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">ANDROID_HOME</span><span class="o">=</span>/usr/local/opt/android-sdk
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$ANDROID_HOME</span>/tools
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$ANDROID_HOME</span>/platform-tools
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$ANDROID_HOME</span>/build-tools <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">ANDROID_BUILD_TOOLS_HOME</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>find <span class="nv">$ANDROID_HOME</span>/build-tools -name aapt <span class="p">|</span> tail -1<span class="k">))</span>
    <span class="nb">echo</span> <span class="s2">&quot;Android Built Tools located: $ANDROID_BUILD_TOOLS_HOME&quot;</span>
    <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$ANDROID_BUILD_TOOLS_HOME</span>:<span class="nv">$PATH</span>
<span class="k">fi</span></code></pre></div>

<p>You noticed that adding Android Build Tools to the path is optional. That’s because we didn’t install Build Tools yet.</p>

<h2 id="update-android-sdk">Update Android SDK</h2>

<p>This is where you update Android SDK, install all the tools and APIs, including Build Tools and Android Support Repository and Library. Remember, this Linux instance is running in the AWS Cloud meaning it’s headless (no GUI) and you only can work with the shell.</p>

<p>If you happened to read older version of this article, you’d remember seeing a lot of shell scripts using <code>grep</code> and the rest.</p>

<p>This is a revised version, with much simpler and cleaner code.</p>

<p>The command that does the job is <code>android update sdk</code>. You need to use <code>--filter</code> option to specify list of packages you need to update or install. To get readable identifiers of all available packages, run the following command</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">android list sdk --all --extended</code></pre></div>

<p><code>--extended</code> flag is used to display extended information about each package, including and human readable identifier. <code>--all</code> is needed to include extra packages, like build tools, by defaults they won’t be listed. Here’s an example output.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">----------
id: <span class="m">3</span> or <span class="s2">&quot;build-tools-20.0.0&quot;</span>
     Type: BuildTool
     Desc: Android SDK Build-tools, revision 20
----------
id: <span class="m">4</span> or <span class="s2">&quot;build-tools-19.1.0&quot;</span>
     Type: BuildTool
     Desc: Android SDK Build-tools, revision 19.1
----------</code></pre></div>

<p>You can now compose filter as a comma-separated list of all package identifiers you want to install. Since it’s a headless build box, you will have to use <code>--no-ui</code> option, and <code>--all</code> is needed to include extra packages.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">FILTER</span><span class="o">=</span>tool,platform,android-20,build-tools-20.0.0,android-19,android-19.0.1
android update sdk --no-ui --all --filter <span class="nv">$FILTER</span></code></pre></div>

<p>This example installs Android SDK Tools, Platform tools, Build tools versions 20.0.0 and 19.0.1, as well as SDK Platform 19 and 20. Customize the list to your needs using proper identifiers.</p>

<h3 id="answering-the-prompts">Answering the Prompts</h3>
<p>But it’s not done yet. When installing or updated, you will have to accept license prompts. Each package can have it’s won license requiring you to answer a prompt with “y”.</p>

<p>You’d probably think of <code>yes</code> command line utility designed for this particular task. However it will not work. <code>yes</code> outputs “y” to stdout too often with no options to put delays in between. Android SDK update tool expects not just “y”, but a “y” followed by return key, in other words, it expects “y\n” string as a whole. I don’t know the exact mechanics of <code>yes</code> command, but if you try something like this</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">FILTER</span><span class="o">=</span>tool,platform,android-20,build-tools-20.0.0,android-19,android-19.0.1
yes <span class="p">|</span> android update sdk --no-ui --all --filter <span class="nv">$FILTER</span></code></pre></div>

<p>you will see that the license prompt will complain about incorrect input and fail after a number of attempts.</p>

<p>The solution is to put certain delay between “y” outputs to stdout. This code I found on the web, it’s reliable and does the job.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">FILTER</span><span class="o">=</span>tool,platform,android-20,build-tools-20.0.0,android-19,android-19.0.1
<span class="o">(</span> sleep <span class="m">5</span> <span class="o">&amp;&amp;</span> <span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span> sleep 1<span class="p">;</span> <span class="nb">echo </span>y<span class="p">;</span> <span class="k">done</span> <span class="o">)</span> <span class="se">\</span>
    <span class="p">|</span> android update sdk --no-ui --all <span class="se">\</span>
    --filter <span class="k">${</span><span class="nv">FILTER</span><span class="k">}</span></code></pre></div>

<h3 id="project-specific-sdk-update">Project Specific SDK Update</h3>
<p>If you have various Android project, each with it’s own requirements for Android packages, it would be reasonable to add Android SDK update task to the project’s build configuration. We are using Gradle, so here’s an example of Gradle task</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">task updateSDK<span class="o">(</span><span class="nb">type</span>: Exec<span class="o">)</span> <span class="o">{</span>
    ext.filter <span class="o">=</span> <span class="s2">&quot;tool,platform-tool,android-20,build-tools-20.0.0,android-19,build-tools-19.1.0,build-tools-19.0.1,extra-android-support,extra-android-m2repository,extra-google-m2repository,extra-google-google_play_services,extra-google-google_play_services_froyo&quot;</span>
    commandLine <span class="s2">&quot;sh&quot;</span>, <span class="s2">&quot;-c&quot;</span>, <span class="s2">&quot;( sleep 5 &amp;&amp; while [ 1 ]; do sleep 1; echo y; done ) \</span>
<span class="s2">    | android update sdk --no-ui --all \</span>
<span class="s2">    --filter ${filter}&quot;</span>
<span class="o">}</span></code></pre></div>

<h3 id="caveats">Caveats</h3>
<p>The last and very annoying bit, is that this script seems to update packages even if they are already installed. At the moment I have no clue what’s causing this behavior and what’s the best workaround. When it comes to running this script on one of the Bamboo agents in the cloud it doesn’t really matter, but when the script runs on one and only Mac build agent we have - this really slows down each build.</p>

<h1 id="install-32-bit-libraries">Install 32-bit Libraries</h1>
<p>Before you try to build anything, you have to do one more thing.</p>

<p>Remember, the host OS is 64-bit Linux system. Android requires a bunch of 32-bit libraries and you have to install them. The Linux system in question is RPM-based so this example uses <code>yum</code> command, change it to <code>apt-get</code> or another package manager specific for your OS.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># install 32-bit libraries</span>
sudo yum install glibc.i686, zlib.i686, libstdc++.so.6 libz.so.1</code></pre></div>

<p>Now you’re good to go!</p>

<h1 id="summary">Summary</h1>

<p>This is a TLDR or a summary section, that simply lists the solution “as is”.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># install 32-bit libraries</span>
sudo yum install glibc.i686, zlib.i686, libstdc++.so.6 libz.so.1</code></pre></div>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># update Android SDK on headless server</span>
<span class="nv">FILTER</span><span class="o">=</span>tool,platform,android-20,build-tools-20.0.0,android-19,android-19.0.1
<span class="o">(</span> sleep <span class="m">5</span> <span class="o">&amp;&amp;</span> <span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span> sleep 1<span class="p">;</span> <span class="nb">echo </span>y<span class="p">;</span> <span class="k">done</span> <span class="o">)</span> <span class="se">\</span>
    <span class="p">|</span> android update sdk --no-ui --all <span class="se">\</span>
    --filter <span class="k">${</span><span class="nv">FILTER</span><span class="k">}</span></code></pre></div>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/atlassian/2014/05/29/atlassian-cli" title="Atlassian CLI Client">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/ios/2014/05/29/resign-appstore-to-enterprise" title="Resign AppStore to Enterprise">Next &rarr;</a>
      
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'mgrebenets'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <section>
      <h4>Published</h4>
      <div class="date"><span>29 May 2014</span></div>
    </section>
    
      <section>
        <h4>Category</h4>
        <span class="category">
          Android
        </span>
      </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#android-ref">android <span>1</span></a></li>
     
    	<li><a href="/tags.html#google-ref">google <span>1</span></a></li>
     
    	<li><a href="/tags.html#aws-ref">aws <span>2</span></a></li>
     
    	<li><a href="/tags.html#amazon-ref">amazon <span>1</span></a></li>
     
    	<li><a href="/tags.html#linux-ref">linux <span>2</span></a></li>
     
    	<li><a href="/tags.html#32-bit-ref">32-bit <span>1</span></a></li>
     
    	<li><a href="/tags.html#gradle-ref">gradle <span>1</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2014 Maksym Grebenets
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    
  </body>
</html>

